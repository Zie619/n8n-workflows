# Docker Compose开发环境配置文件
# 使用方式：docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# 该文件扩展了基础docker-compose.yml，为开发环境提供额外配置

services:
  # N8N工作流文档服务 - 开发模式配置
  workflows-docs:
    # 构建配置
    build:
      context: .  # 构建上下文（当前目录）
      dockerfile: Dockerfile  # 使用的Dockerfile
      target: development  # 构建开发环境目标（Dockerfile中的multi-stage构建）
    # 卷挂载配置 - 开发环境专用
    volumes:
      - .:/app  # 将当前目录挂载到容器内的/app目录（代码热重载）
      - /app/database  # 匿名卷：避免数据库文件被主机文件覆盖
      - /app/.venv  # 匿名卷：避免虚拟环境文件被主机文件覆盖
    # 开发环境特定的环境变量
    environment:
      - ENVIRONMENT=development  # 运行环境设置为开发环境
      - LOG_LEVEL=debug  # 日志级别设置为debug（详细日志）
      - DEBUG=true  # 启用调试模式
      - RELOAD=true  # 启用代码自动重载
    # 开发环境启动命令
    command: ["python", "run.py", "--host", "0.0.0.0", "--port", "8000", "--dev"]
    # 端口映射 - 开发环境多端口配置
    ports:
      - "8000:8000"  # 主服务端口映射
      - "8001:8001"  # 测试用的备用端口
    # 配置文件 - 空数组表示默认启用
    profiles: []  # 无需指定--profile即可启动该服务

  # 开发环境数据库管理工具（可选）
  db-admin:
    # 使用的Adminer镜像（轻量级数据库管理工具）
    image: adminer:latest
    # 容器名称
    container_name: db-admin
    # 端口映射 - Adminer web界面
    ports:
      - "8080:8080"  # 将主机的8080端口映射到容器的8080端口
    # 环境变量配置
    environment:
      - ADMINER_DEFAULT_SERVER=workflows-docs  # 默认连接的数据库服务器
    # 网络配置
    networks:
      - workflows-network  # 连接到工作流网络
    # 配置文件 - 仅当启用dev-tools时才启动
    profiles:
      - dev-tools

  # 开发环境文件监视器 - 用于代码自动重载
  file-watcher:
    # 使用的Node.js镜像（用于运行文件监视脚本）
    image: node:18-alpine
    # 容器名称
    container_name: file-watcher
    # 工作目录
    working_dir: /app  # 设置容器内的工作目录
    # 卷挂载
    volumes:
      - .:/app  # 将当前目录挂载到容器内的/app目录（监视文件变化）
    # 启动命令 - 运行开发监视脚本
    command: ["npm", "run", "dev-watch"]
    # 网络配置
    networks:
      - workflows-network  # 连接到工作流网络
    # 配置文件 - 仅当启用dev-tools时才启动
    profiles:
      - dev-tools